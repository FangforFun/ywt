/**
 * @(#)GKRegMtListInfoCallback.java 2013-11-4 Copyright 2013 it.kedacom.com,
 *                                  Inc. All rights reserved.
 * 
 *                                  <pre>
 *  ------------------------------
 * <?xml version="1.0" encoding="utf-8"?>
 * <TrueTouchAndroid>
 * <EventID>29890</EventID>
 * <Message>
 * <GKRegMtListInfo>
 * 		<Result>1</Result>
 * 		<TerNum>16</TerNum>
 * 		<bHasNext>0</bHasNext>
 * 		<TerList>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 			<TMtInfo>
 * 				<TerAddrType>0</TerAddrType>
 * 				<TerIP>1592366536</TerIP>
 * 				<Alias></Alias>
 * 			</TMtInfo>
 * 		</TerList>
 * 	</GKRegMtListInfo>
 * </Message>
 * </TrueTouchAndroid>
 * ------------------------------
 * </pre>
 * 
 * ------------------------------
<?xml version="1.0" encoding="utf-8"?>
<TrueTouchAndroid>
<EventID>29890</EventID>
<Message>
<GKRegMtListInfo>
	<Result>1</Result>
	<TerNum>4</TerNum>
	<bHasNext>0</bHasNext>
	<TerList>
		<TMtInfo>
			<E164Info>
				<TerAddrType>1</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[0512009]]></Alias>
			</E164Info>
			<H323IdInfo>
				<TerAddrType>2</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[?Administrator?的 iPad]]></Alias>
			</H323IdInfo>
		</TMtInfo>
		<TMtInfo>
			<E164Info>
				<TerAddrType>1</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[658455]]></Alias>
			</E164Info>
			<H323IdInfo>
				<TerAddrType>2</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[MVC Android手机658455]]></Alias>
			</H323IdInfo>
		</TMtInfo>
		<TMtInfo>
			<E164Info>
				<TerAddrType>1</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[1258053]]></Alias>
			</E164Info>
			<H323IdInfo>
				<TerAddrType>2</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[pcmtdd55]]></Alias>
			</H323IdInfo>
		</TMtInfo>
		<TMtInfo>
			<E164Info>
				<TerAddrType>1</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[0002]]></Alias>
			</E164Info>
			<H323IdInfo>
				<TerAddrType>2</TerAddrType>
				<TerIP>0.0.0.0</TerIP>
				<Alias><![CDATA[MVC Android手机0002]]></Alias>
			</H323IdInfo>
		</TMtInfo>
		</TerList>
	</GKRegMtListInfo>
</Message>
</TrueTouchAndroid>
------------------------------

 * 
 */

package com.kedacom.mvc_demo.mtc.jni;

import android.app.Activity;

import com.gkzxhn.gkprison.application.AppStackManager;
import com.pc.utils.StringUtils;
import com.kedacom.mvc_demo.ContactListActivity;
import com.kedacom.mvc_demo.login.LoginFlowService;
import com.kedacom.mvc_demo.vconf.bean.E164Info;
import com.kedacom.mvc_demo.vconf.bean.H323IdInfo;
import com.kedacom.mvc_demo.vconf.bean.TagTMTAddr;
import com.kedacom.truetouch.mtc.BaseCallbackHandler;

import org.dom4j.Document;
import org.dom4j.DocumentHelper;
import org.dom4j.Element;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

/**
 * 终端列表
 * 
 * @author chenjian
 * @date 2013-11-4
 */

public class GKRegMtListInfoCallback extends BaseCallbackHandler {

	private List<TagTMTAddr> mTagTMTAddrs;

	private boolean mHasNext = true;

	private final String mInvalidIP = "0.0.0.0";

	@Override
	public void addCallback(final String strXML) {
		mTagTMTAddrs = new ArrayList<TagTMTAddr>();
		parserXML(strXML);

		if (!mHasNext) {
			Activity currActivity = AppStackManager.Instance()
					.currentActivity();
			if (null != currActivity
					&& currActivity instanceof ContactListActivity) {
				((ContactListActivity) currActivity).showList(mTagTMTAddrs);
			}
		}
	}

	private void parserXML(String strXML) {
		if (StringUtils.isNull(strXML)) {
			return;
		}

		try {
			Document doc = DocumentHelper.parseText(strXML);
			Element rootElt = doc.getRootElement();
			if (null == rootElt) {
				return;
			}

			Element msgEle = (Element) rootElt.element("Message");
			Element gkregMtListInfoEle = (Element) msgEle
					.element("GKRegMtListInfo");
			if (null == gkregMtListInfoEle) {
				return;
			}

			String result = gkregMtListInfoEle.elementTextTrim("Result");
			if (!StringUtils.equals(result, "1")) {
				return;
			}

			mHasNext = StringUtils.equals(
					gkregMtListInfoEle.elementTextTrim("bHasNext"), "1");

			int terNum = StringUtils.str2Int(
					gkregMtListInfoEle.elementTextTrim("TerNum"), 0);
			if (terNum == 0) {
				return;
			}

			Element terListEle = (Element) gkregMtListInfoEle
					.element("TerList");
			if (null == terListEle) {
				return;
			}

			Iterator it = terListEle.elementIterator("TMtInfo");
			if (null == it) {
				return;
			}

			while (it.hasNext()) {
				Element mtInfoElt = (Element) it.next();
				if (mtInfoElt == null)
					continue;

				TagTMTAddr tagTMTAddr = new TagTMTAddr();
				Element e164InfoElt = mtInfoElt.element("E164Info");
				Element h323IdInfoElt = mtInfoElt.element("H323IdInfo");

				if (null != e164InfoElt) {
					E164Info e164Info = new E164Info();

					String ip = e164InfoElt.elementTextTrim("TerIP");
					// 无效的IP
					if (StringUtils.equals(mInvalidIP, ip)
							|| StringUtils.equals("0", ip)) {
						ip = "";
					}
					e164Info.mTerIP = ip;
					e164Info.mAlias = e164InfoElt.elementTextTrim("Alias");
					// e164Info.mAddrType =
					// EmMtAddrType.toEmMtAddrType(e164InfoElt
					// .elementTextTrim("TerAddrType"));

					tagTMTAddr.mE164Info = e164Info;
				}

				if (null != h323IdInfoElt) {
					H323IdInfo h323IdInfo = new H323IdInfo();

					String ip = h323IdInfoElt.elementTextTrim("TerIP");
					// 无效的IP
					if (StringUtils.equals(mInvalidIP, ip)
							|| StringUtils.equals("0", ip)) {
						ip = "";
					}
					h323IdInfo.mTerIP = ip;
					h323IdInfo.mAlias = h323IdInfoElt.elementTextTrim("Alias");
					// h323IdInfo.mAddrType = EmMtAddrType
					// .toEmMtAddrType(h323IdInfoElt
					// .elementTextTrim("TerAddrType"));

					tagTMTAddr.mH323IdInfo = h323IdInfo;
				}

				String ip = "";
				String e164 = "";
				String alias = "";

				if (tagTMTAddr.mH323IdInfo != null) {
					ip = tagTMTAddr.mH323IdInfo.mTerIP;
					alias = tagTMTAddr.mH323IdInfo.mAlias;
				}

				if (tagTMTAddr.mE164Info != null) {
					e164 = tagTMTAddr.mE164Info.mAlias;
				}

				if (StringUtils.isNull(alias) && tagTMTAddr.mE164Info != null) {
					ip = tagTMTAddr.mE164Info.mTerIP;
					alias = tagTMTAddr.mE164Info.mAlias;
				}

				// 屏蔽掉登录用户
				if (StringUtils.equals(e164, LoginFlowService.getE164())) {
					continue;
				}

				mTagTMTAddrs.add(tagTMTAddr);
			}
		} catch (Exception e) {
		}
	}
}
